# AutoCAD 梁編號自動標註 - 快速入門

## 📋 整體流程圖

```
ETABS 結構模型 (.e2k)
        ↓
  HTML 編號工具 (index.html)
        ↓ 執行編號
  Excel 對照表 + JSON 座標檔
        ↓
  AutoCAD 外掛 (BeamLabeler.dll)
        ↓ 讀取 JSON
  AutoCAD 圖檔自動標註
```

---

## 🚀 快速開始 (3 步驟)

### Step 1: 產生 JSON 檔案

1. 用瀏覽器開啟 `index.html`
2. 上傳你的 E2K 檔案 (例如: `Twin 2F.e2k`)
3. 設定編號參數後，點「執行編號」
4. 點「**匯出 JSON (給AutoCAD用)**」
5. 儲存為 `beam_data.json`

### Step 2: 編譯外掛 (只需做一次)

```bash
cd AutoCAD_Labeling
dotnet build -c Release
```

找到編譯好的檔案：
`bin\Release\net8.0\BeamLabeler.dll`

### Step 3: 在 AutoCAD 中使用

1. 開啟 AutoCAD，載入你的 DWG 平面圖
2. 輸入命令: `NETLOAD`
3. 選擇 `BeamLabeler.dll`
4. 輸入命令: `LABELBEAMS`
5. 依照提示選擇 `beam_data.json`
6. 完成！

---

## 💡 常見情境

### 情境 1: 標註單一樓層

```
命令: LABELBEAMS
→ 選擇 JSON 檔案
→ 輸入 1 (選擇 2F)
→ 選擇 Manual (手動點選基準點)
→ 點選軸線 0-A 交點
→ 輸入 1000 (縮放比例)
→ 輸入 250 (文字高度)
→ 完成！
```

### 情境 2: 自動偵測基準點

```
命令: LABELBEAMS
→ 選擇 JSON 檔案
→ 輸入 1
→ 選擇 Auto (自動偵測)
→ 系統自動找到軸線交點
→ 輸入 1000
→ 輸入 250
→ 完成！
```

### 情境 3: 檢查軸線偵測

```
命令: SHOWGRIDS
→ 顯示所有偵測到的軸線
```

---

## ⚙️ 參數說明

| 參數 | 預設值 | 說明 | 範例 |
|------|--------|------|------|
| 基準點 | - | ETABS 原點對應的 AutoCAD 座標 | 軸線 0-A |
| 縮放比例 | 1000 | m 轉 mm 的比例 | 1m = 1000mm |
| 文字高度 | 250 | 標註文字大小 | 250 (適合 1:100) |

---

## 🎯 座標對應原理

### ETABS 座標系統
```
    Y
    ↑
    |
    |  ● (梁中點)
    |     座標: (11.7, 2.6) 公尺
    |
    └────────→ X
  (0,0)
```

### AutoCAD 座標系統
```
    Y (mm)
    ↑
    |
    |  ● (標註位置)
    |     = 基準點 + (11700, 2600)
    |
    └────────→ X (mm)
  基準點 (你點選的位置)
```

---

## 🔧 故障排除

### 問題 1: 標註位置錯誤

**原因**: 基準點選錯或縮放比例不對

**解決**:
1. 檢查是否點選正確的軸線交點
2. 確認 AutoCAD 單位:
   - 如果是 mm → 縮放比例 1000
   - 如果是 cm → 縮放比例 100
   - 如果是 m → 縮放比例 1

### 問題 2: 找不到軸線 (Auto 模式失敗)

**原因**: 軸線標註不是標準文字

**解決**:
使用 Manual 模式手動點選基準點

### 問題 3: 文字太小/太大

**解決**:
- 調整文字高度參數
- 或標註後使用 AutoCAD 的 `SCALETEXT` 命令

---

## 📊 實際範例

假設你有一根梁:
- **ETABS 編號**: B65
- **新編號**: GAa-2
- **ETABS 座標**: 起點 (11.7, 2.6), 終點 (16.8, 2.6)
- **梁中點**: (14.25, 2.6) 公尺

標註流程:
1. 基準點選在 AutoCAD 的 (5000, 3000) mm
2. 縮放比例 1000
3. 標註位置 = (5000 + 14250, 3000 + 2600) = (19250, 5600)
4. 在該位置寫上文字「GAa-2」

---

## 📁 檔案結構

```
編號/
├── index.html              ← HTML 編號工具
├── sketch.js               ← P5.js 背景動畫
└── AutoCAD_Labeling/       ← C# 外掛專案
    ├── BeamLabeler.csproj
    ├── Commands.cs          ← 主命令 (LABELBEAMS)
    ├── GridDetector.cs      ← 軸線偵測 (SHOWGRIDS)
    ├── Models/
    │   └── BeamData.cs      ← JSON 資料模型
    └── README.md
```

---

## 🎓 進階技巧

### 批次標註多個樓層

目前需要手動執行多次 `LABELBEAMS`，每次選擇不同樓層。

未來可以擴充為自動批次標註。

### 自訂圖層顏色

標註後，在 AutoCAD 的圖層管理員中設定:
- `梁編號-大梁` → 紅色
- `梁編號-小梁` → 藍色

### 調整文字樣式

修改 `Commands.cs` 中的文字建立部分:

```csharp
text.TextStyleId = // 你的文字樣式 ID
text.Rotation = Math.PI / 4; // 旋轉 45 度
```

---

## ❓ 常見問答

**Q: 需要 Visual Studio 嗎?**
A: 不需要！只要安裝 .NET SDK，在 VS Code 或命令列就能編譯。

**Q: 支援其他版本的 AutoCAD 嗎?**
A: 需要修改 `.csproj` 中的 DLL 參考路徑。

**Q: 可以標註到配置空間嗎?**
A: 目前只支援模型空間，需要修改程式碼才能支援配置空間。

**Q: JSON 檔案可以編輯嗎?**
A: 可以！用文字編輯器開啟，調整座標或編號後儲存即可。

---

## 📞 需要幫助?

如果遇到問題，請提供:
1. E2K 檔案截圖
2. AutoCAD 圖面截圖
3. 錯誤訊息截圖

祝使用愉快！🎉
